<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
      xmlns:f="http://xmlns.jcp.org/jsf/core">

    <h:head>
        <ui:param name="title" value="TEST: JSF2.2 @ViewScoped references in session by navigation method: JS/AJAX version 14 Jun 2015"/>
        <title>#{title}</title>
    </h:head>
    <h:body>

 <h:outputScript name="jsf.js" library="javax.faces" target="head" />
 
    <script type="text/javascript">
        function cleanViewScope() {
            //alert("cleanViewScope(): this"+this);// this: [object Window]  
            alert("cleanViewScope(): this.href:"+this.href);// this.href:undefined
            //alert("cleanViewScope(): event:"+event); //event:[object MouseEvent]
                    //jsf.ajax.request(this, null, {this, event, {target:this.href});//SyntaxError: Unexpected token ','. Expected a ':' following the property name 'this'.
      //jsf.ajax.request(this, null, {this, event, {target:this.href}}); //SyntaxError: Unexpected token ','. Expected a ':' following the property name 'this'.
                    //jsf.ajax.request(this, event, {target:this.href});//typeerror undefined is not a function (evaluating 'context.element.hasAttribute("type"))
                    //jsf.ajax.request(this, null, {target:this.href});//typeerror undefined is not a function (evaluating 'context.element.hasAttribute("type"))
                    //alert("cleanViewScope() called");
                    jsf.ajax.request(this, null, {execute: 'someButton', target: this.href});
                    return false;
                }                
    </script>  
        
<script type="text/javascript">
<!--
function displayMessage(firstName) {
    alert("Hello " + firstName + ", hope you like JavaScript functions!")
}
//-->
</script>
        
        <h2>#{title}</h2>

        <p>
            <b>Author:</b> Darren Kelly (Webel IT Australia)
        </p>

        <p>
            <em>
                For comparison of heap memory references to a JSF2.2 @ViewScoped @Named bean after different navigation methods.
            </em>
        </p>

        <p>Mojarra 2.2.9; Glassfish4; NetBeans8.0.2; JDK1.7</p>

        <hr/>

<form>
First name:
<input type="input" name="yourName" />
<input
  type="button"
  onclick="displayMessage(form.yourName.value)"
  value="Display Message" />

<input
  type="button"
  onclick="cleanViewScope()"
  value="cleanViewScope()" />
</form>        
        
        <p>
            Use the @ViewScoped bean to read a simple String variable.
        </p>

        <h:panelGroup>
            <h:outputLabel value="Backing variable: newName:" style="font-weight: bold;"/>&nbsp;
            <h:outputText value="#{jsf22ViewBean.newName}"/>            
        </h:panelGroup>

        <hr/>

        <h3>Navigate to the 'done' page using different methods then examine the heap (in NetBeans IDE or VisualVM)</h3>

        <ui:param name="info_not_gc" value="@ViewScoped bean will NOT be garbage collected afterwards !"/>

        <ui:param name="info_yes_gc" value="@ViewScoped bean will be garbage collected OK afterwards."/>

        <ui:param name="root" value="#{request.contextPath}/" />

        <p>
            - <h:outputLink value="#{root}faces/done.xhtml">h:outputLink: GET: done</h:outputLink> 
            : <span style="color:red">#{info_not_gc}</span>
        </p>

<h:button id="sampleButton" binding="#{sampleButton}" value="Sample" />
<h:outputText value="sampleButton's client ID : #{sampleButton.clientId}" />

        <f:phaseListener type="com.stackoverflow.kolossus.ViewScopeCleanerAjax" />
        <p>
            - <h:link id="someButton2" onclick="cleanViewScope()" value="h:link: GET: done (with JS/AJAX intercept)" outcome="done?faces-redirect=true"/> 

            <!--
            - <h:link binding="someButton" onclick="cleanViewScope()" value="h:link: GET: done (with JS/AJAX intercept)" outcome="done?faces-redirect=true"/> 
            //java.lang.String cannot be cast to javax.faces.component.UIComponent
            -->
            
            <!--
            <h:link onclick="jsf.ajax.request(this, null, {target:this.href}); return false;" value="h:link: GET: done (with JS/AJAX intercept)" outcome="done?faces-redirect=true"/> 
            -->
            
            : <span style="color:red">#{info_not_gc} </span>
<form>            
</form>
        </p>

        <p>
            - <a href="#{root}faces/done.xhtml">HTML &lt;A&gt;: GET: done</a> 
            : <span style="color:red">#{info_not_gc}</span>
        </p>

        <fieldset><legend>Form</legend>        
            <h:form id="form">

            - <h:link id="someButton" onclick="cleanViewScope()" value="h:link: GET: done (with JS/AJAX intercept)" outcome="done?faces-redirect=true"/> 
                
                <p>
                    - <h:commandButton value="h:commandButton: TO 'done' via action method" action="#{jsf22ViewBean.actionDone()}"/>
                    : <span style="color:green;">#{info_yes_gc}</span>
                </p>            
                <p>
                    - <h:commandButton value="h:commandButton: TO 'done' via action String" action="done"/>
                    : <span style="color:green;">#{info_yes_gc}</span>
                </p>

                <hr/>

                <p>
                    - <h:commandButton value="h:commandButton: STAY: action method returns 'null'" action="#{jsf22ViewBean.actionNull()}"/> : no additional @ViewScoped bean created.
                </p>            

            </h:form>
        </fieldset>

        <p>
            - <b>Browser reload of this page:</b> creates a new @ViewScoped bean, previous <span style="color:red">#{info_not_gc}</span>
        </p>

        <hr/>

    </h:body>
</html>

